"""\nStreamlit UI –¥–ª—è –ø–æ–∏—Å–∫–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã –ø–æ –ø–æ—ç–∑–∏–∏.\n"""\nimport os\nimport logging\nimport streamlit as st\nimport pandas as pd\nimport plotly.graph_objects as go\nfrom typing import List, Optional\nfrom dataclasses import dataclass\nfrom pymongo import MongoClient, UpdateOne\n\n\n# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è\nlogging.basicConfig(\n    level=logging.INFO,\n    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',\n    handlers=[\n        logging.StreamHandler(),\n        logging.FileHandler('search_app.log')\n    ]\n)\n\n\n# –ü–æ–ø—ã—Ç–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ C++ –º–æ—Å—Ç–∞ (–º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏)\ntry:\n    from search_bridge import SearchEngine, SearchResult\n    SEARCH_ENGINE_AVAILABLE = True\nexcept Exception as e:\n    SEARCH_ENGINE_AVAILABLE = False\n    print(f\"Warning: C++ search engine not available: {e}\")\n\n\n# –ò–º–ø–æ—Ä—Ç –º–æ–¥—É–ª–µ–π –æ—Ü–µ–Ω–∫–∏\ntry:\n    from evaluation import SearchEvaluator\n    EVALUATION_AVAILABLE = True\nexcept Exception as e:\n    EVALUATION_AVAILABLE = False\n    print(f\"Warning: Evaluation module not available: {e}\")\n\n\n@dataclass\nclass DisplayResult:\n    \"\"\"–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–∏—Å–∫–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.\"\"\"\n    doc_id: int\n    score: float\n    title: str\n    text: str\n    author: str\n    year: str\n\n\nclass SearchApp:\n    \"\"\"Streamlit –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞.\"\"\"\n    \n    def __init__(self, progress_callback=None):\n        self.mongo_uri = os.getenv(\"MONGO_URI\", \"mongodb://mongodb:27017\")\n        self.db_name = os.getenv(\"DB_NAME\", \"poetry_search\")\n        self.lib_path = os.getenv(\"LIB_PATH\", None)\n        self.progress_callback = progress_callback\n        self.logger = logging.getLogger(__name__)\n        \n        self._init_mongo()\n        self._init_search_engine()\n    \n    def _init_mongo(self):\n        \"\"\"–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MongoDB.\"\"\"\n        try:\n            self.mongo_client = MongoClient(self.mongo_uri, serverSelectionTimeoutMS=5000)\n            self.mongo_client.admin.command('ping')\n            self.db = self.mongo_client[self.db_name]\n            self.collection = self.db[\"poems\"]\n            self.mongo_available = True\n            self.logger.info(\"MongoDB connected successfully\")\n        except Exception as e:\n            self.logger.error(f\"MongoDB not available: {e}\")\n            self.mongo_available = False\n            self.collection = None\n    \n    def _init_search_engine(self):\n        \"\"\"–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è C++ –ø–æ–∏—Å–∫–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã.\"\"\"\n        if SEARCH_ENGINE_AVAILABLE:\n            try:\n                self.search_engine = SearchEngine(lib_path=self.lib_path)\n                self.engine_available = True\n                self.logger.info(\"C++ search engine initialized\")\n                \n                # –ï—Å–ª–∏ MongoDB –¥–æ—Å—Ç—É–ø–Ω–∞, –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç—ã –≤ –∏–Ω–¥–µ–∫—Å\n                if self.mongo_available and self.search_engine.get_document_count() == 0:\n                    self._load_index_from_mongo()\n            except Exception as e:\n                self.logger.error(f\"Search engine error: {e}\")\n                self.search_engine = None\n                self.engine_available = False\n        else:\n            self.search_engine = None\n            self.engine_available = False\n    \n    def _load_index_from_mongo(self, limit: int = 50000):\n        \"\"\"–ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏–∑ MongoDB –≤ C++ –∏–Ω–¥–µ–∫—Å.\"\"\"\n        if self.collection is None or not self.search_engine:\n            return\n        \n        # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ cpp_doc_id –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏–µ–π\n        self.collection.update_many({}, {\"$unset\": {\"cpp_doc_id\": \"\"}})\n        \n        self.logger.info(f\"Starting to index documents (limit: {limit})...\")\n        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ _id –¥–ª—è –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞\n        cursor = self.collection.find().sort(\"_id\", 1).limit(limit)\n        \n        # –ü–æ–ª—É—á–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞\n        total = min(limit, self.collection.count_documents({}))\n        \n        # Batch –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è MongoDB\n        batch_size = 500\n        bulk_operations = []\n        \n        for idx, doc in enumerate(cursor, 1):\n            content = doc.get(\"text\", \"\")\n            title = doc.get(\"title\", \"\")\n            \n            if content:\n                # –î–æ–±–∞–≤–ª—è–µ–º –≤ C++ –∏–Ω–¥–µ–∫—Å\n                cpp_id = self.search_engine.add_document(content, title)\n                \n                # –ù–∞–∫–∞–ø–ª–∏–≤–∞–µ–º bulk –æ–ø–µ—Ä–∞—Ü–∏–∏\n                bulk_operations.append(\n                    UpdateOne(\n                        {\"_id\": doc[\"_id\"]},\n                        {\"$set\": {\"cpp_doc_id\": cpp_id}}\n                    )\n                )\n                \n                # –í—ã–ø–æ–ª–Ω—è–µ–º batch –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ\n                if len(bulk_operations) >= batch_size:\n                    self.collection.bulk_write(bulk_operations, ordered=False)\n                    bulk_operations = []\n                \n                # –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å\n                if idx % 1000 == 0:\n                    progress = idx / total\n                    self.logger.info(f\"Indexed {idx}/{total} documents ({progress*100:.1f}%)\")\n                    if self.progress_callback:\n                        self.progress_callback(progress, f\"–ò–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–æ {idx}/{total} –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤\")\n        \n        # –î–æ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –æ–ø–µ—Ä–∞—Ü–∏–∏\n        if bulk_operations:\n            self.collection.bulk_write(bulk_operations, ordered=False)\n        \n        indexed_count = self.search_engine.get_document_count()\n        self.logger.info(f\"Indexing complete! Total indexed: {indexed_count}\")\n        if self.progress_callback:\n            self.progress_callback(1.0, f\"–ì–æ—Ç–æ–≤–æ! –ò–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–æ {indexed_count} –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤\")\n    \n    def search_tfidf(self, query: str, top_k: int = 10) -> List[DisplayResult]:\n        \"\"\"TF-IDF –ø–æ–∏—Å–∫.\"\"\"\n        results = []\n        \n        if self.engine_available and self.search_engine:\n            search_results = self.search_engine.search_tfidf(query, top_k)\n            \n            for sr in search_results:\n                doc = self._get_doc_by_cpp_id(sr.doc_id)\n                if doc:\n                    results.append(DisplayResult(\n                        doc_id=sr.doc_id,\n                        score=sr.score,\n                        title=doc.get(\"title\", \"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è\"),\n                        text=doc.get(\"text\", \"\")[:500] + \"...\",\n                        author=doc.get(\"author\", \"–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω\"),\n                        year=doc.get(\"year\", \"\"),\n                    ))\n        \n        return results\n    \n    def search_boolean(self, query: str, top_k: int = 10) -> List[DisplayResult]:\n        \"\"\"–ë—É–ª–µ–≤ –ø–æ–∏—Å–∫ —Å TF-IDF —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ–º.\"\"\"\n        self.logger.info(f\"Boolean search: query='{query}', top_k={top_k}\")\n        results = []\n    \n        if self.engine_available and self.search_engine:\n            # 1. –ü–æ–ª—É—á–∞–µ–º –±—É–ª–µ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ AND/OR/NOT)\n            doc_ids = self.search_engine.boolean_query(query)\n            self.logger.info(f\"Boolean search: C++ returned {len(doc_ids)} document IDs\")\n        \n            if not doc_ids:\n                self.logger.warning(f\"Boolean search: No results found for query '{query}'\")\n                return []\n        \n            # 2. –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ—Ä–º–∏–Ω—ã –∑–∞–ø—Ä–æ—Å–∞ (–±–µ–∑ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤)\n            query_terms = self._extract_query_terms(query)\n        \n            if not query_terms:\n                # –ï—Å–ª–∏ –Ω–µ—Ç —Ç–µ—Ä–º–∏–Ω–æ–≤, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–≤—ã–µ top_k —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤\n                for doc_id in doc_ids[:top_k]:\n                    doc = self._get_doc_by_cpp_id(doc_id)\n                    if doc:\n                        results.append(DisplayResult(\n                            doc_id=doc_id,\n                            score=0.0,\n                            title=doc.get(\"title\", \"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è\"),\n                            text=doc.get(\"text\", \"\")[:500] + \"...\",\n                            author=doc.get(\"author\", \"–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω\"),\n                            year=doc.get(\"year\", \"\"),\n                        ))\n                return results\n        \n            # 3. –ü–æ–ª—É—á–∞–µ–º TF-IDF –¥–ª—è –≤—Å–µ–≥–æ –∏–Ω–¥–µ–∫—Å–∞\n            clean_query = ' '.join(query_terms)\n            # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, —á—Ç–æ–±—ã –ø–æ–∫—Ä—ã—Ç—å –±—É–ª–µ–≤—ã–π –Ω–∞–±–æ—Ä\n            # –ù–æ –Ω–µ –±–æ–ª—å—à–µ —Ä–∞–∑—É–º–Ω–æ–≥–æ –ª–∏–º–∏—Ç–∞\n            search_limit = min(len(doc_ids), 100)\n            tfidf_results = self.search_engine.search_tfidf(clean_query, top_k=search_limit)\n        \n            # 4. –°–æ–∑–¥–∞—ë–º set –∏–∑ –±—É–ª–µ–≤—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏\n            boolean_set = set(doc_ids)\n        \n            # 5. –§–∏–ª—å—Ç—Ä—É–µ–º TF-IDF —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, –æ—Å—Ç–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ –±—É–ª–µ–≤—ã–µ\n            for tfidf_res in tfidf_results:\n                if tfidf_res.doc_id in boolean_set:\n                    doc = self._get_doc_by_cpp_id(tfidf_res.doc_id)\n                    if doc:\n                        results.append(DisplayResult(\n                            doc_id=tfidf_res.doc_id,\n                            score=tfidf_res.score,\n                            title=doc.get(\"title\", \"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è\"),\n                            text=doc.get(\"text\", \"\")[:500] + \"...\",\n                            author=doc.get(\"author\", \"–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω\"),\n                            year=doc.get(\"year\", \"\"),\n                        ))\n                    \n                        # –ö–∞–∫ —Ç–æ–ª—å–∫–æ –ø–æ–ª—É—á–∏–ª–∏ top_k, –º–æ–∂–µ–º –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è\n                        if len(results) >= top_k:\n                            break\n        \n            # 6. –ï—Å–ª–∏ –Ω–µ —Ö–≤–∞—Ç–∏–ª–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –¥–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –±–µ–∑ score\n            if len(results) < top_k:\n                scored_ids = {r.doc_id for r in results}\n                for doc_id in doc_ids:\n                    if doc_id not in scored_ids:\n                        doc = self._get_doc_by_cpp_id(doc_id)\n                        if doc:\n                            results.append(DisplayResult(\n                                doc_id=doc_id,\n                                score=0.0,\n                                title=doc.get(\"title\", \"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è\"),\n                                text=doc.get(\"text\", \"\")[:500] + \"...\",\n                                author=doc.get(\"author\", \"–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω\"),\n                                year=doc.get(\"year\", \"\"),\n                            ))\n                            if len(results) >= top_k:\n                                break\n        \n            self.logger.info(f\"Boolean search: Returning {len(results)} ranked results\")\n    \n        return results\n\n    \n    def _extract_query_terms(self, query: str) -> List[str]:\n        \"\"\"–ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–µ—Ä–º–∏–Ω—ã –∑–∞–ø—Ä–æ—Å–∞, –∏—Å–∫–ª—é—á–∞—è –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã AND/OR/NOT –∏ —Å–∫–æ–±–∫–∏.\"\"\"\n        operators = {'and', 'or', 'not', '(', ')'}\n        \n        # –†–∞–∑–±–∏–≤–∞–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ç–æ–∫–µ–Ω—ã\n        tokens = query.lower().replace('(', ' ( ').replace(')', ' ) ').split()\n        \n        # –§–∏–ª—å—Ç—Ä—É–µ–º –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã\n        terms = [t for t in tokens if t not in operators and t.strip()]\n        \n        self.logger.debug(f\"Extracted query terms: {terms} from query: '{query}'\")\n        return terms\n    \n    def _get_doc_by_cpp_id(self, cpp_id: int) -> Optional[dict]:\n        \"\"\"–ü–æ–ª—É—á–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –∏–∑ MongoDB –ø–æ C++ ID.\"\"\"\n        if self.collection is not None:\n            return self.collection.find_one({\"cpp_doc_id\": cpp_id})\n        return None\n    \n    def get_stats(self) -> dict:\n        \"\"\"–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã.\"\"\"\n        stats = {\n            \"mongo_available\": self.mongo_available,\n            \"engine_available\": self.engine_available,\n            \"mongo_docs\": 0,\n            \"indexed_docs\": 0,\n        }\n        \n        if self.mongo_available and self.collection is not None:\n            stats[\"mongo_docs\"] = self.collection.count_documents({})\n        \n        if self.engine_available and self.search_engine:\n            stats[\"indexed_docs\"] = self.search_engine.get_document_count()\n        \n        return stats\n\n\ndef render_search_tab(app: SearchApp):\n    \"\"\"–í–∫–ª–∞–¥–∫–∞ –ø–æ–∏—Å–∫–∞.\"\"\"\n    search_mode = st.radio(\n        \"–†–µ–∂–∏–º –ø–æ–∏—Å–∫–∞:\",\n        [\"TF-IDF (—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å)\", \"–ë—É–ª–µ–≤ (AND/OR/NOT)\"],\n        horizontal=True,\n    )\n    \n    query = st.text_input(\n        \"–í–≤–µ–¥–∏—Ç–µ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å:\",\n        placeholder=\"love AND heart\" if \"–ë—É–ª–µ–≤\" in search_mode else \"eternal love\",\n    )\n    \n    col1, col2 = st.columns([1, 4])\n    with col1:\n        top_k = st.number_input(\"–†–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:\", min_value=1, max_value=100, value=10)\n    \n    if st.button(\"üîç –ò—Å–∫–∞—Ç—å\", type=\"primary\"):\n        if query:\n            with st.spinner(\"–ü–æ–∏—Å–∫...\"):\n                if \"TF-IDF\" in search_mode:\n                    results = app.search_tfidf(query, top_k)\n                else:\n                    results = app.search_boolean(query, top_k)\n            \n            if results:\n                st.success(f\"–ù–∞–π–¥–µ–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: {len(results)}\")\n                \n                for i, res in enumerate(results, 1):\n                    with st.expander(f\"{i}. {res.title} (score: {res.score:.4f})\"):\n                        st.markdown(f\"**–ê–≤—Ç–æ—Ä:** {res.author}\")\n                        if res.year:\n                            st.markdown(f\"**–ì–æ–¥:** {res.year}\")\n                        st.markdown(\"---\")\n                        st.text(res.text)\n            else:\n                st.warning(\"–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å.\")\n        else:\n            st.info(\"–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞.\")\n\n\ndef render_metrics_tab(app: SearchApp):\n    \"\"\"–í–∫–ª–∞–¥–∫–∞ –±–µ–Ω—á–º–∞—Ä–∫–æ–≤ –∏ –º–µ—Ç—Ä–∏–∫.\"\"\"\n    st.header(\"üìä –û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –ø–æ–∏—Å–∫–∞\")\n    \n    if not EVALUATION_AVAILABLE:\n        st.error(\"‚ùå –ú–æ–¥—É–ª—å evaluation.py –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.\")\n        return\n    \n    if not app.engine_available:\n        st.warning(\"‚ö†Ô∏è –ü–æ–∏—Å–∫–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ë–µ–Ω—á–º–∞—Ä–∫–∏ –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω—ã.\")\n        return\n    \n    st.markdown(\"\"\"\n    –≠—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ü–µ–Ω–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –ø–æ–∏—Å–∫–∞ —Å –ø–æ–º–æ—â—å—é –º–µ—Ç—Ä–∏–∫:\n    - **Precision@k** - –¥–æ–ª—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ —Ç–æ–ø-k\n    - **DCG@k** - —É—á–∏—Ç—ã–≤–∞–µ—Ç –ø–æ–∑–∏—Ü–∏—é –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤\n    - **NDCG@k** - –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π DCG\n    - **ERR@k** - –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–Ω–∞—è –º–µ—Ç—Ä–∏–∫–∞ –æ–∂–∏–¥–∞–µ–º–æ–≥–æ —Ä–∞–Ω–≥–∞\n    \"\"\")\n    \n    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–Ω—á–º–∞—Ä–∫–∞\n    st.subheader(\"‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–Ω—á–º–∞—Ä–∫–∞\")\n    \n    col1, col2 = st.columns(2)\n    \n    with col1:\n        search_mode = st.selectbox(\n            \"–†–µ–∂–∏–º –ø–æ–∏—Å–∫–∞:\",\n            [\"tfidf\", \"boolean\"],\n            index=0\n        )\n        \n        n_synthetic = st.number_input(\n            \"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:\",\n            min_value=5,\n            max_value=100,\n            value=20,\n            help=\"–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –æ—Ü–µ–Ω–∫–∏\"\n        )\n    \n    with col2:\n        top_k = st.number_input(\n            \"Top-K –¥–ª—è –æ—Ü–µ–Ω–∫–∏:\",\n            min_value=5,\n            max_value=50,\n            value=10\n        )\n        \n        use_synthetic = st.checkbox(\n            \"–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã\",\n            value=True,\n            help=\"–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–ª—É—á–∞–π–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∏–∑ –∫–æ—Ä–ø—É—Å–∞\"\n        )\n    \n    # –ö–Ω–æ–ø–∫–∞ –∑–∞–ø—É—Å–∫–∞\n    if st.button(\"üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–µ–Ω—á–º–∞—Ä–∫\", type=\"primary\"):\n        with st.spinner(\"–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –ø–æ–∏—Å–∫–∞...\"):\n            try:\n                # –°–æ–∑–¥–∞—ë–º evaluator\n                evaluator = SearchEvaluator(app)\n                \n                # –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Ü–µ–Ω–∫—É\n                results = evaluator.evaluate_all(\n                    search_mode=search_mode,\n                    top_k=top_k,\n                    use_synthetic=use_synthetic,\n                    n_synthetic=n_synthetic\n                )\n                \n                # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ session_state\n                st.session_state.benchmark_results = results\n                \n            except Exception as e:\n                st.error(f\"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –±–µ–Ω—á–º–∞—Ä–∫–∞: {e}\")\n                st.exception(e)\n    \n    # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤\n    if \"benchmark_results\" in st.session_state:\n        results = st.session_state.benchmark_results\n        \n        if results:\n            st.success(f\"‚úÖ –ë–µ–Ω—á–º–∞—Ä–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω! –û—Ü–µ–Ω–µ–Ω–æ –∑–∞–ø—Ä–æ—Å–æ–≤: {results.get('n_queries', 0)}\")\n            \n            # –£—Å—Ä–µ–¥–Ω–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏\n            st.subheader(\"üìà –£—Å—Ä–µ–¥–Ω–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏\")\n            \n            avg_metrics = results.get('avg_metrics', {})\n            \n            if avg_metrics:\n                # –°–æ–∑–¥–∞—ë–º DataFrame –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã\n                k_values = sorted(list(avg_metrics['P'].keys()))\n                \n                metrics_data = {\n                    '–ú–µ—Ç—Ä–∏–∫–∞': ['P', 'DCG', 'NDCG', 'ERR']\n                }\n                \n                for k in k_values:\n                    metrics_data[f'@{k}'] = [\n                        avg_metrics['P'][k],\n                        avg_metrics['DCG'][k],\n                        avg_metrics['NDCG'][k],\n                        avg_metrics['ERR'][k]\n                    ]\n                \n                df_metrics = pd.DataFrame(metrics_data)\n                \n                # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–∞–±–ª–∏—Ü—É\n                st.dataframe(\n                    df_metrics.style.format({col: \"{:.4f}\" for col in df_metrics.columns if col != '–ú–µ—Ç—Ä–∏–∫–∞'}),\n                    use_container_width=True\n                )\n                \n                # –ì—Ä–∞—Ñ–∏–∫–∏ –º–µ—Ç—Ä–∏–∫\n                st.subheader(\"üìä –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫\")\n                \n                # –°–æ–∑–¥–∞—ë–º –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ —Å Plotly\n                fig = go.Figure()\n                \n                colors = {\n                    'P': '#1f77b4',\n                    'DCG': '#ff7f0e',\n                    'NDCG': '#2ca02c',\n                    'ERR': '#d62728'\n                }\n                \n                for metric_name in ['P', 'NDCG', 'ERR']:\n                    values = [avg_metrics[metric_name][k] for k in k_values]\n                    \n                    fig.add_trace(go.Scatter(\n                        x=[f'@{k}' for k in k_values],\n                        y=values,\n                        mode='lines+markers',\n                        name=metric_name,\n                        line=dict(color=colors[metric_name], width=2),\n                        marker=dict(size=8)\n                    ))\n                \n                fig.update_layout(\n                    title='–ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –ø–æ–∏—Å–∫–∞',\n                    xaxis_title='Top-K',\n                    yaxis_title='–ó–Ω–∞—á–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫–∏',\n                    hovermode='x unified',\n                    legend=dict(\n                        orientation=\"h\",\n                        yanchor=\"bottom\",\n                        y=1.02,\n                        xanchor=\"right\",\n                        x=1\n                    )\n                )\n                \n                st.plotly_chart(fig, use_container_width=True)\n                \n                # –û—Ç–¥–µ–ª—å–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ –¥–ª—è DCG (–º–æ–∂–µ—Ç –∏–º–µ—Ç—å –¥—Ä—É–≥–æ–π –º–∞—Å—à—Ç–∞–±)\n                fig_dcg = go.Figure()\n                \n                dcg_values = [avg_metrics['DCG'][k] for k in k_values]\n                \n                fig_dcg.add_trace(go.Scatter(\n                    x=[f'@{k}' for k in k_values],\n                    y=dcg_values,\n                    mode='lines+markers',\n                    name='DCG',\n                    line=dict(color=colors['DCG'], width=2),\n                    marker=dict(size=8)\n                ))\n                \n                fig_dcg.update_layout(\n                    title='DCG (–±–µ–∑ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏)',\n                    xaxis_title='Top-K',\n                    yaxis_title='DCG',\n                    hovermode='x unified'\n                )\n                \n                st.plotly_chart(fig_dcg, use_container_width=True)\n                \n                # –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –∑–∞–ø—Ä–æ—Å–∞–º (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)\n                with st.expander(\"üîç –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –∑–∞–ø—Ä–æ—Å–∞–º\"):\n                    per_query = results.get('per_query_metrics', [])\n                    \n                    if per_query:\n                        for i, query_result in enumerate(per_query[:10], 1):\n                            st.markdown(f\"**{i}. {query_result['query']}**\")\n                            \n                            query_metrics = query_result.get('metrics', {})\n                            \n                            # –ú–∏–Ω–∏-—Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞\n                            mini_data = {'–ú–µ—Ç—Ä–∏–∫–∞': ['NDCG@10', 'P@10', 'ERR@10']}\n                            mini_data['–ó–Ω–∞—á–µ–Ω–∏–µ'] = [\n                                query_metrics.get('NDCG', {}).get(10, 0.0),\n                                query_metrics.get('P', {}).get(10, 0.0),\n                                query_metrics.get('ERR', {}).get(10, 0.0)\n                            ]\n                            \n                            st.dataframe(\n                                pd.DataFrame(mini_data).style.format({'–ó–Ω–∞—á–µ–Ω–∏–µ': \"{:.4f}\"}),\n                                hide_index=True\n                            )\n                            \n                            if i >= 10:\n                                st.info(f\"–ü–æ–∫–∞–∑–∞–Ω—ã –ø–µ—Ä–≤—ã–µ 10 –∏–∑ {len(per_query)} –∑–∞–ø—Ä–æ—Å–æ–≤\")\n                                break\n\n\ndef main():\n    st.set_page_config(\n        page_title=\"Poetry Search Engine\",\n        page_icon=\"üìú\",\n        layout=\"wide\",\n    )\n    \n    st.title(\"üìú Poetry Search Engine\")\n    st.markdown(\"*–ü–æ–∏—Å–∫–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ –∫–æ—Ä–ø—É—Å—É –ø–æ—ç–∑–∏–∏ (C++ backend + Streamlit UI)*\")\n    \n    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è\n    if \"app\" not in st.session_state:\n        # –°–æ–∑–¥–∞—ë–º progress bar\n        progress_bar = st.progress(0)\n        status_text = st.empty()\n        \n        def update_progress(progress: float, text: str):\n            progress_bar.progress(progress)\n            status_text.text(text)\n        \n        status_text.text(\"–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö...\")\n        st.session_state.app = SearchApp(progress_callback=update_progress)\n        \n        # –û—á–∏—â–∞–µ–º UI –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏\n        progress_bar.empty()\n        status_text.empty()\n    \n    app = st.session_state.app\n    \n    # –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π\n    with st.sidebar:\n        st.header(\"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\")\n        stats = app.get_stats()\n        \n        st.metric(\"MongoDB\", \"‚úÖ –î–æ—Å—Ç—É–ø–Ω–∞\" if stats[\"mongo_available\"] else \"‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–Ω–∞\")\n        st.metric(\"C++ Engine\", \"‚úÖ –ê–∫—Ç–∏–≤–µ–Ω\" if stats[\"engine_available\"] else \"‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω\")\n        st.metric(\"–î–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ MongoDB\", stats[\"mongo_docs\"])\n        st.metric(\"–ü—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–æ\", stats[\"indexed_docs\"])\n        \n        st.markdown(\"---\")\n        st.markdown(\"\"\"\n        **–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**\n        - TF-IDF —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ\n        - –ë—É–ª–µ–≤ –ø–æ–∏—Å–∫ (AND, OR, NOT)\n        - LZW-—Å–∂–∞—Ç–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤\n        - Porter Stemmer\n        - –ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ (P, NDCG, ERR)\n        \"\"\")\n    \n    # –í–∫–ª–∞–¥–∫–∏\n    tab1, tab2 = st.tabs([\"üîç –ü–æ–∏—Å–∫\", \"üìä –ú–µ—Ç—Ä–∏–∫–∏\"])\n    \n    with tab1:\n        render_search_tab(app)\n    \n    with tab2:\n        render_metrics_tab(app)\n    \n    # –î–µ–º–æ —Ä–µ–∂–∏–º –µ—Å–ª–∏ –¥–≤–∏–∂–æ–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω\n    if not app.engine_available:\n        st.warning(\"\"\"\n        ‚ö†Ô∏è **C++ –ø–æ–∏—Å–∫–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.**\n        \n        –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:\n        1. –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ `libsearch_engine.so` —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–∞\n        2. –ü—É—Ç—å –∫ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ —É–∫–∞–∑–∞–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `LIB_PATH`\n        \"\"\")\n\n\nif __name__ == \"__main__\":\n    main()\n