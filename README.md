# Poetry Search Engine

–ü–æ–∏—Å–∫–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ –∫–æ—Ä–ø—É—Å—É –ø–æ—ç–∑–∏–∏ –¥–ª—è –∫—É—Ä—Å–∞ "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –ø–æ–∏—Å–∫" –ú–ê–ò.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```mermaid
graph TB
    subgraph "Frontend"
        UI[Streamlit UI<br/>app.py]
    end
    
    subgraph "Python Layer"
        CLI[CLI<br/>cli.py]
        EVAL[Evaluation<br/>evaluation.py]
        METRICS[Metrics<br/>metrics.py]
        BRIDGE[Search Bridge<br/>search_bridge.py<br/>ctypes FFI]
        LOADER[Data Loader<br/>data_loader.py]
    end
    
    subgraph "C++ Core"
        LIB[libsearch_engine.so]
        
        subgraph "Search"
            SEARCHDB[TSearchDatabase]
            TFIDF[TTfIdf]
            BOOL[TBooleanSearch]
            INV[TInvertedIndex]
        end
        
        subgraph "Text Processing"
            TOK[TTokenizer]
            STEM[TPorterStemmer]
            LZW[TLzw Compression]
        end
        
        subgraph "Data Structures"
            VEC[TVector]
            MAP[TMap / TUnorderedMap]
            SET[TSet / TUnorderedSet]
            STR[TString]
        end
    end
    
    subgraph "Storage"
        MONGO[(MongoDB<br/>poems collection)]
    end
    
    UI --> BRIDGE
    CLI --> BRIDGE
    UI --> EVAL
    EVAL --> METRICS
    BRIDGE --> LIB
    LOADER --> MONGO
    UI --> MONGO
    LIB --> SEARCHDB
    SEARCHDB --> TFIDF
    SEARCHDB --> BOOL
    SEARCHDB --> INV
    TFIDF --> TOK
    BOOL --> TOK
    TOK --> STEM
    SEARCHDB --> LZW
    SEARCHDB --> VEC
    SEARCHDB --> MAP
    SEARCHDB --> STR
```

## –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### C++ (lib/)

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|----------|
| `TVector`, `TList`, `TDeque`, `TQueue`, `THeap` | STL-–ø–æ–¥–æ–±–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –±–µ–∑ STL |
| `TUnorderedMap`, `TUnorderedSet` | –•–µ—à-—Ç–∞–±–ª–∏—Ü—ã (Robin Hood) |
| `TMap`, `TSet` | –ö—Ä–∞—Å–Ω–æ-—á—ë—Ä–Ω—ã–µ –¥–µ—Ä–µ–≤—å—è |
| `TString` | –°—Ç—Ä–æ–∫–∞ —Å SSO –∏ FNV-1a —Ö–µ—à–µ–º |
| `TTokenizer` | –¢–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ |
| `TPorterStemmer`, `TLemmatizer` | –°—Ç–µ–º–º–∏–Ω–≥ / –ª–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏—è |
| `TInvertedIndex` | –ò–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–Ω–¥–µ–∫—Å |
| `TBooleanSearch` | –ë—É–ª–µ–≤ –ø–æ–∏—Å–∫ (AND/OR/NOT) |
| `TTfIdf` | TF-IDF —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ |
| `TZipfAnalyzer` | –ê–Ω–∞–ª–∏–∑ –ø–æ –∑–∞–∫–æ–Ω—É –¶–∏–ø—Ñ–∞ |
| `TLzw` | LZW-—Å–∂–∞—Ç–∏–µ |
| `TSearchDatabase` | –í—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –ë–î –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ |

### Python (server/)

- **app.py** ‚Äî Streamlit –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å –≤–∫–ª–∞–¥–∫–∞–º–∏ –ø–æ–∏—Å–∫–∞ –∏ –º–µ—Ç—Ä–∏–∫
- **cli.py** ‚Äî CLI —É—Ç–∏–ª–∏—Ç–∞ (stdin ‚Üí stdout)
- **search_bridge.py** ‚Äî ctypes –æ–±—ë—Ä—Ç–∫–∞ –Ω–∞–¥ C++
- **data_loader.py** ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ JSONL –≤ MongoDB –∏ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é
- **metrics.py** ‚Äî —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫ –∫–∞—á–µ—Å—Ç–≤–∞ (P@k, DCG, NDCG, ERR)
- **evaluation.py** ‚Äî –∫–ª–∞—Å—Å SearchEvaluator –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –ø–æ–∏—Å–∫–∞

## –°–±–æ—Ä–∫–∞

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- CMake 3.14+
- C++17 —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä (GCC 8+, Clang 7+, MSVC 2017+)
- Python 3.8+
- MongoDB 4.4+

### –°–±–æ—Ä–∫–∞ C++ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏

```bash
mkdir build && cd build
cmake ..
cmake --build . -j$(nproc)
```

–ü–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ –ø—É—Ç–∏ `build/search_system/libsearch_engine.so` (Linux) –∏–ª–∏ `libsearch_engine.dylib` (macOS).

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ C++

```bash
cd build
ctest -j4 --output-on-failure
```

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
cd server
pip install -r requirements.txt
```

### –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω–æ

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ MongoDB:
```bash
mongod --dbpath /path/to/data
```

2. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ (–æ–¥–∏–Ω —Ä–∞–∑):
```bash
cd server
python data_loader.py --input ../data/poetry50k.dedup.jsonl
```

3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ Streamlit:
```bash
cd server
LIB_PATH=../build/search_system/libsearch_engine.so streamlit run app.py
```

## –ó–∞–ø—É—Å–∫ —Å Docker

```bash
cp ~/Desktop/poetry50k.dedup.jsonl data/

docker-compose up -d

docker-compose run --rm data_loader

# –û—Ç–∫—Ä—ã—Ç—å http://localhost:8501
```

## CLI –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```bash
echo "eternal love" | python server/cli.py --mode tfidf --top-k 10

echo "love AND heart" | python server/cli.py --mode boolean

python server/cli.py --interactive
```

## –û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –ø–æ–∏—Å–∫–∞

–í –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –¥–æ—Å—Ç—É–ø–Ω–∞ –≤–∫–ª–∞–¥–∫–∞ **"üìä –ú–µ—Ç—Ä–∏–∫–∏"**, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–∑–≤–æ–ª—è–µ—Ç:

- –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±–µ–Ω—á–º–∞—Ä–∫ –Ω–∞ —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
- –í—ã–±—Ä–∞—Ç—å —Ä–µ–∂–∏–º –ø–æ–∏—Å–∫–∞ (TF-IDF –∏–ª–∏ Boolean)
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–µ—Å—Ç–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (5-100)
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Top-K –¥–ª—è –æ—Ü–µ–Ω–∫–∏ (5-200) –∏–ª–∏ –æ—Ü–µ–Ω–∏—Ç—å –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏

#### Precision@k (P@k)
–î–æ–ª—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ —Ç–æ–ø-k –≤—ã–¥–∞—á–µ.

$$P@k = \frac{|\text{—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –≤ —Ç–æ–ø-}k|}{k}$$

- **–î–∏–∞–ø–∞–∑–æ–Ω**: [0, 1]
- **–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è**: P@10 = 0.6 –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ 6 –∏–∑ 10 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –≤—ã–¥–∞—á–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã
- **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å**: –∫–æ–≥–¥–∞ –≤–∞–∂–Ω–æ, —á—Ç–æ–±—ã –∫–∞–∂–¥—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±—ã–ª —Ä–µ–ª–µ–≤–∞–Ω—Ç–µ–Ω

#### DCG@k (Discounted Cumulative Gain)
–£—á–∏—Ç—ã–≤–∞–µ—Ç –Ω–µ —Ç–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å, –Ω–æ –∏ –ø–æ–∑–∏—Ü–∏—é –¥–æ–∫—É–º–µ–Ω—Ç–∞ ‚Äî –±–æ–ª–µ–µ –≤—ã—Å–æ–∫–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –≤–∞–∂–Ω–µ–µ.

$$DCG@k = \sum_{i=1}^{k} \frac{rel_i}{\log_2(i+1)}$$

- **–î–∏–∞–ø–∞–∑–æ–Ω**: [0, ‚àû)
- **–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è**: —á–µ–º –≤—ã—à–µ, —Ç–µ–º –ª—É—á—à–µ. –†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–∞ –ø–µ—Ä–≤—ã—Ö –ø–æ–∑–∏—Ü–∏—è—Ö –¥–∞—é—Ç –±–æ–ª—å—à–∏–π –≤–∫–ª–∞–¥
- **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å**: –∫–æ–≥–¥–∞ –ø–æ—Ä—è–¥–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤–∞–∂–µ–Ω

#### NDCG@k (Normalized DCG)
DCG, –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∏–¥–µ–∞–ª—å–Ω–æ–π –≤—ã–¥–∞—á–∏ (–∫–æ–≥–¥–∞ –≤—Å–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–∞ –ø–µ—Ä–≤—ã—Ö –ø–æ–∑–∏—Ü–∏—è—Ö).

$$NDCG@k = \frac{DCG@k}{IDCG@k}$$

–≥–¥–µ IDCG@k ‚Äî DCG –¥–ª—è –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—è.

- **–î–∏–∞–ø–∞–∑–æ–Ω**: [0, 1]
- **–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è**: NDCG@10 = 0.85 –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –≤—ã–¥–∞—á–∞ –Ω–∞ 85% —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∏–¥–µ–∞–ª—å–Ω–æ–π
- **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å**: –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ä–∞–∑–Ω—ã—Ö –ø–æ–∏—Å–∫–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º –Ω–∞ –æ–¥–Ω–∏—Ö –¥–∞–Ω–Ω—ã—Ö

#### ERR@k (Expected Reciprocal Rank)
–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–Ω–∞—è –º–µ—Ç—Ä–∏–∫–∞, –º–æ–¥–µ–ª–∏—Ä—É—é—â–∞—è –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: –æ–Ω –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑ –∏ –º–æ–∂–µ—Ç –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –Ω–∞ –ª—é–±–æ–º —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–º –¥–æ–∫—É–º–µ–Ω—Ç–µ.

$$ERR@k = \sum_{i=1}^{k} \frac{1}{i} \prod_{j=1}^{i-1}(1-R_j) \cdot R_i$$

–≥–¥–µ $R_i = \frac{2^{rel_i}-1}{2^{max\_grade}}$ ‚Äî –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–º –Ω–∞ –ø–æ–∑–∏—Ü–∏–∏ i.

- **–î–∏–∞–ø–∞–∑–æ–Ω**: [0, 1]
- **–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è**: —É—á–∏—Ç—ã–≤–∞–µ—Ç, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–µ–∫—Ä–∞—â–∞–µ—Ç –ø–æ–∏—Å–∫ –ø–æ—Å–ª–µ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞
- **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å**: –∫–æ–≥–¥–∞ –º–æ–¥–µ–ª–∏—Ä—É–µ—Ç—Å—è —Ä–µ–∞–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

- **–¢–∞–±–ª–∏—Ü–∞** —Å —É—Å—Ä–µ–¥–Ω–µ–Ω–Ω—ã–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏ –ø–æ –≤—Å–µ–º –∑–∞–ø—Ä–æ—Å–∞–º –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π k
- **–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ Plotly**:
  - –û—Å–Ω–æ–≤–Ω–æ–π –≥—Ä–∞—Ñ–∏–∫: P, NDCG, ERR –ø–æ –≤—Å–µ–º –∑–Ω–∞—á–µ–Ω–∏—è–º k
  - –û—Ç–¥–µ–ª—å–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ –¥–ª—è DCG (–∏–º–µ–µ—Ç –¥—Ä—É–≥–æ–π –º–∞—Å—à—Ç–∞–±)
  - –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –ø–æ –∑–∞–ø—Ä–æ—Å–∞–º —Å —Ü–≤–µ—Ç–æ–≤–æ–π —à–∫–∞–ª–æ–π
- **–î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã** –ø–æ –∫–∞–∂–¥–æ–º—É –∑–∞–ø—Ä–æ—Å—É —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –≤—ã–±–æ—Ä–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### –ó–∞–ø—É—Å–∫ –±–µ–Ω—á–º–∞—Ä–∫–∞

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É **"üìä –ú–µ—Ç—Ä–∏–∫–∏"**
2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
   - –†–µ–∂–∏–º –ø–æ–∏—Å–∫–∞ (tfidf/boolean)
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 50)
   - Top-K –¥–ª—è –æ—Ü–µ–Ω–∫–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 50)
3. –ù–∞–∂–º–∏—Ç–µ **"üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–µ–Ω—á–º–∞—Ä–∫"**
4. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç–æ–±—Ä–∞–∑—è—Ç—Å—è –≤ –≤–∏–¥–µ —Ç–∞–±–ª–∏—Ü –∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–π

- [x] üî¥ –¢–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è
- [x] üî¥ –°—Ç–µ–º–º–∏–Ω–≥
- [x] üü¢ –õ–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏—è
- [x] üî¥ –ó–∞–∫–æ–Ω –¶–∏–ø—Ñ–∞
- [x] üî¥ –ë—É–ª–µ–≤ –∏–Ω–¥–µ–∫—Å
- [x] üî¥ –ë—É–ª–µ–≤ –ø–æ–∏—Å–∫
- [x] üü° TF-IDF
- [x] üü° –°–∂–∞—Ç–∏–µ (LZW)
- [x] üü° –ê–≤—Ç–æ—Ç–µ—Å—Ç—ã (288 —é–Ω–∏—Ç-—Ç–µ—Å—Ç–æ–≤)

## –î–∞—Ç–∞—Å–µ—Ç

**Poetry 50K**: https://ciir.cs.umass.edu/downloads/poetry/

570,930 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Å—Ç–∏—Ö–æ—Ç–≤–æ—Ä–µ–Ω–∏–π –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ.
