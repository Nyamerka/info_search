# Poetry Search Engine

Поисковая система по корпусу поэзии для курса "Информационный поиск" МАИ.

## Архитектура

```
┌─────────────────────────────────────────────────────────────┐
│                    Streamlit UI (Python)                    │
│                        app.py                               │
└──────────────────────────┬──────────────────────────────────┘
                           │ ctypes FFI
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                  libsearch_engine.so (C++)                  │
│  ┌─────────────┐  ┌──────────────┐  ┌─────────────────┐     │
│  │ TSearchDB   │  │ TInvertedIdx │  │ TBooleanSearch  │     │
│  └─────────────┘  └──────────────┘  └─────────────────┘     │
│  ┌─────────────┐  ┌──────────────┐  ┌─────────────────┐     │
│  │ TTfIdf      │  │ TPorterStem  │  │ TLzw (сжатие)   │     │
│  └─────────────┘  └──────────────┘  └─────────────────┘     │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                      MongoDB (документы)                    │
└─────────────────────────────────────────────────────────────┘
```

## Реализованные компоненты

### C++ (lib/)

| Компонент | Описание |
|-----------|----------|
| `TVector`, `TList`, `TDeque`, `TQueue`, `THeap` | STL-подобные контейнеры без STL |
| `TUnorderedMap`, `TUnorderedSet` | Хеш-таблицы (Robin Hood) |
| `TMap`, `TSet` | Красно-чёрные деревья |
| `TString` | Строка с SSO и FNV-1a хешем |
| `TTokenizer` | Токенизация текста |
| `TPorterStemmer`, `TLemmatizer` | Стемминг / лемматизация |
| `TInvertedIndex` | Инвертированный индекс |
| `TBooleanSearch` | Булев поиск (AND/OR/NOT) |
| `TTfIdf` | TF-IDF ранжирование |
| `TZipfAnalyzer` | Анализ по закону Ципфа |
| `TLzw` | LZW-сжатие |
| `TSearchDatabase` | Высокоуровневая БД документов |

### Python (server/)

- **app.py** — Streamlit веб-интерфейс с вкладками поиска и метрик
- **cli.py** — CLI утилита (stdin → stdout)
- **search_bridge.py** — ctypes обёртка над C++
- **data_loader.py** — загрузка JSONL в MongoDB и индексацию
- **metrics.py** — реализация метрик качества (P@k, DCG, NDCG, ERR)
- **evaluation.py** — класс SearchEvaluator для оценки качества поиска

## Сборка

```bash
# Сборка C++
mkdir build && cd build
cmake ..
cmake --build .

# Запуск тестов
ctest -j4 --output-on-failure
```

## Запуск с Docker

```bash
# Положить датасет
cp ~/Desktop/poetry50k.dedup.jsonl data/

# Запустить MongoDB + Streamlit
docker-compose up -d

# Загрузить данные (один раз)
docker-compose run --rm data_loader

# Открыть http://localhost:8501
```

## CLI использование

```bash
# TF-IDF поиск
echo "eternal love" | python server/cli.py --mode tfidf --top-k 10

# Булев поиск
echo "love AND heart" | python server/cli.py --mode boolean

# Интерактивный режим
python server/cli.py --interactive
```

## Оценка качества поиска

В веб-интерфейсе доступна вкладка **"📊 Метрики"**, которая позволяет:

- Запустить автоматический бенчмарк на синтетических запросах
- Выбрать режим поиска (TF-IDF или Boolean)
- Настроить количество тестовых запросов (5-100)
- Настроить Top-K для оценки (5-50)

### Реализованные метрики

- **Precision@k (P@k)** - доля релевантных документов в топ-k выдаче
- **DCG@k** - Discounted Cumulative Gain (учитывает позицию документов)
- **NDCG@k** - нормализованный DCG к идеальной выдаче (от 0 до 1)
- **ERR@k** - Expected Reciprocal Rank (вероятностная метрика)

### Визуализация результатов

- **Таблица** с усредненными метриками по всем запросам для @1, @3, @5, @10
- **Интерактивные графики Plotly** для анализа динамики метрик:
  - Основной график: P, NDCG, ERR
  - Отдельный график для DCG (может иметь другой масштаб)
- **Детальные результаты** по каждому запросу с возможностью выбора количества отображаемых запросов (5-100)

### Запуск бенчмарка

1. Перейдите на вкладку **"📊 Метрики"**
2. Настройте параметры:
   - Режим поиска (tfidf/boolean)
   - Количество синтетических запросов (по умолчанию 50)
   - Top-K для оценки (по умолчанию 50)
3. Нажмите **"🚀 Запустить бенчмарк"**
4. Результаты отобразятся в виде таблиц и графиков

## Требования лабораторной

- [x] 🔴 Токенизация
- [x] 🔴 Стемминг
- [x] 🟢 Лемматизация
- [x] 🔴 Закон Ципфа
- [x] 🔴 Булев индекс
- [x] 🔴 Булев поиск
- [x] 🟡 TF-IDF
- [x] 🟡 Сжатие (LZW)
- [x] 🟡 Автотесты (288 юнит-тестов)
- [x] 🟢 Метрики качества (P, DCG, NDCG, ERR)
- [x] 🟢 Веб-интерфейс для оценки качества
- [x] 🟢 Визуализация метрик (таблицы и графики)

## Датасет

**Poetry 50K**: https://ciir.cs.umass.edu/downloads/poetry/

570,930 уникальных стихотворений на английском языке.

## Лицензия

[1](https://ppl-ai-file-upload.s3.amazonaws.com/web/direct-files/attachments/images/148376543/6947e767-c9ac-4a7e-a621-5fc83071b2aa/Snimok-ekrana-2025-12-28-v-17.53.48.jpg)
[2](https://ppl-ai-file-upload.s3.amazonaws.com/web/direct-files/attachments/images/148376543/7f59fee5-ca10-4eab-b1dc-d970a65575f8/Snimok-ekrana-2025-12-28-v-17.54.35.jpg)
[3](https://ppl-ai-file-upload.s3.amazonaws.com/web/direct-files/attachments/148376543/036c5e56-2c34-46bb-a589-31f22cd953be/paste-3.txt)